<?xml version="1.0" encoding="UTF-8"?>
<UserControl x:Class="NTC.FamilyManager.Views.CuratorView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:NTC.FamilyManager.Views"
             xmlns:vm="clr-namespace:NTC.FamilyManager.ViewModels"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:converters="clr-namespace:NTC.FamilyManager.UI.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600"
             d:DesignWidth="800"
             d:DataContext="{d:DesignInstance vm:FamilyCuratorViewModel}">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/MahApps.Metro.ALB;component/Styles/Controls.xaml" />
                <ResourceDictionary Source="/MahApps.Metro.ALB;component/styles/light.blue.xaml" />
                <ResourceDictionary Source="/MaterialDesignThemes.Wpf.ALB;component/Themes/materialdesigntheme.light.xaml" />
                <ResourceDictionary Source="/MaterialDesignThemes.Wpf.ALB;component/Themes/materialdesigntheme.defaults.xaml" />
                <ResourceDictionary Source="/AlphaBIMWPF;component/Resource/Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
            <converters:FileNameConverter x:Key="FileNameConverter" />
            <converters:ThumbnailToImageConverter x:Key="ThumbnailToImageConverter" />
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid Background="White">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <!-- Header Controls -->
        <materialDesign:ColorZone Mode="PrimaryMid"
                                  Padding="16"
                                  Grid.Row="0">
            <StackPanel Orientation="Horizontal">
                <Button Command="{Binding SelectFolderCommand}"
                        Content="CHỌN THƯ MỤC"
                        Style="{DynamicResource MaterialDesignRaisedButton}"
                        Background="White"
                        Foreground="{DynamicResource PrimaryHueMidBrush}"
                        Margin="0,0,10,0" />
                <Button Command="{Binding SelectFilesCommand}"
                        Content="CHỌN FILE"
                        Style="{DynamicResource MaterialDesignRaisedButton}"
                        Background="White"
                        Foreground="{DynamicResource PrimaryHueMidBrush}" />
                <TextBlock Text="{Binding StatusMessage}"
                           VerticalAlignment="Center"
                           Margin="20,0,0,0"
                           Foreground="White"
                           FontWeight="Bold" />
            </StackPanel>
        </materialDesign:ColorZone>
        <!-- Main DataGrid -->
        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding Proposals}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  EnableRowVirtualization="True"
                  EnableColumnVirtualization="False"
                  VirtualizingPanel.IsVirtualizing="True"
                  VirtualizingPanel.VirtualizationMode="Recycling"
                  Margin="10"
                  Style="{DynamicResource MaterialDesignDataGrid}">
            <DataGrid.Resources>
                <Style TargetType="{x:Type Button}"
                       BasedOn="{DynamicResource ButtonStyle}" />
            </DataGrid.Resources>
            <DataGrid.Columns>
                <DataGridTemplateColumn Header="Thumbnail"
                                        Width="100">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Grid Height="64"
                                  Width="64">
                                <!-- Placeholder Icon -->
                                <materialDesign:PackIcon Kind="FamilyTree"
                                                         Opacity="0.3"
                                                         Width="40"
                                                         Height="40"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center" />
                                <!-- Actual Thumbnail -->
                                <Image Source="{Binding ThumbnailPath, Converter={StaticResource ThumbnailToImageConverter}}"
                                       Stretch="Uniform">
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Style.Triggers>
                                                <Trigger Property="Source"
                                                         Value="{x:Null}">
                                                    <Setter Property="Visibility"
                                                            Value="Collapsed" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>
                            </Grid>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Tên hiện tại"
                                    Binding="{Binding OriginalPath, Converter={StaticResource FileNameConverter}}"
                                    IsReadOnly="True"
                                    Width="*" />
                <DataGridTemplateColumn Header="Đề xuất Tên NTC (Admin có thể sửa)"
                                        Width="2*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding FamilyName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{DynamicResource MaterialDesignFloatingHintTextBox}"
                                     materialDesign:HintAssist.Hint="Nhập tên chuẩn..." />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Category"
                                    Binding="{Binding Category}"
                                    IsReadOnly="True"
                                    Width="100" />
                <DataGridTemplateColumn Header="Hạng mục"
                                        Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding DataContext.Disciplines, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                      SelectedItem="{Binding Discipline, UpdateSourceTrigger=PropertyChanged}"
                                      Style="{DynamicResource MaterialDesignFloatingHintComboBox}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="Thao tác"
                                        Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Button Command="{Binding DataContext.CommitSelectedCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"
                                        Style="{DynamicResource MaterialDesignIconButton}"
                                        ToolTip="Duyệt và Lưu">
                                    <materialDesign:PackIcon Kind="CheckCircle"
                                                             Foreground="Green" />
                                </Button>
                                <Button Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"
                                        Style="{DynamicResource MaterialDesignIconButton}"
                                        ToolTip="Loại bỏ">
                                    <materialDesign:PackIcon Kind="CloseCircle"
                                                             Foreground="Red" />
                                </Button>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
        <!-- Footer Actions -->
        <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="16">
            <ProgressBar Style="{DynamicResource MaterialDesignLinearProgressBar}"
                         Value="{Binding ProgressValue}"
                         Minimum="0"
                         Maximum="100"
                         Width="200"
                         IsIndeterminate="False"
                         Visibility="{Binding IsProcessing, Converter={StaticResource BooleanToVisibilityConverter}}"
                         Margin="0,0,16,0" />
            <Button Command="{Binding CommitAllCommand}"
                    Content="DUYỆT TẤT CẢ VÀ LƯU VÀO THƯ VIỆN"
                    Style="{DynamicResource MaterialDesignRaisedAccentButton}" />
        </StackPanel>
    </Grid>
</UserControl>